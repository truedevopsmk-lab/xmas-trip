name: Inject Navigation Menu

on:
  push:
    branches: [ "main" ]

jobs:
  inject:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Inject nav into README.md
      run: |
        echo "=== NAV TEMPLATE CONTENT ==="
        cat nav-template.md || (echo "nav-template.md missing!" && exit 1)

        NAV="$(cat nav-template.md)"

        # Loop through all README.md files
        find . -type f -name "README.md" | while read file; do
          # Skip if already injected
          if grep -q "<!-- inject-nav -->" "$file"; then
            echo "Skipping $file — nav already present."
            continue
          fi

          echo "Injecting nav into $file"

          TMP=$(mktemp)
          echo "$NAV" > "$TMP"
          echo "" >> "$TMP"
          cat "$file" >> "$TMP"
          mv "$TMP" "$file"
        done

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        git add .
        git commit -m "Auto-injected nav menu" || echo "No changes to commit."
        git push || echo "Cannot push — likely no permissions."
