name: Inject Navigation Menu

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

jobs:
  inject-nav:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # allows committing changes
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Create nav template
        run: |
          cat << 'EOF' > nav-template.md
          <details>
          <summary><strong>ğŸ“˜ Navigation Menu</strong> (click to expand)</summary>

          - [ğŸ  Home](/)
          - [ğŸš€ PRE-EFS Dev](/README.md)
          - [ğŸ§° EKS Toolkit](/pre-eks-provisioning-toolkit/README.md)
          - [ğŸ›  Istio Install](/istio-install/README.md)
          - [ğŸŒ Gloo Install](/gloo-install/README.md)
          - [ğŸ§ª Crossplane Tests](/test-crossplane/README.md)

          </details>

          ---
          EOF

      - name: Inject nav into README.md files
        run: |
          NAV=$(cat nav-template.md)

          # Loop through all README.md files
          for file in $(find . -type f -name "README.md"); do
            # Skip if nav already exists
            if grep -q "ğŸ“˜ Navigation Menu" "$file"; then
              echo "Skipping $file â€” nav already present."
              continue
            fi
            
            echo "Injecting nav into $file"
            TMPFILE=$(mktemp)

            # Write nav + original content
            echo "$NAV" > "$TMPFILE"
            cat "$file" >> "$TMPFILE"
            mv "$TMPFILE" "$file"
          done

      - name: Commit changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "Auto-injected navigation menu"
            git push
          else
            echo "No changes to commit."
          fi
