name: Inject Navigation Menu

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
      - ".github/nav-template.md"

jobs:
  inject:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Load nav template
      id: nav
      run: |
        NAV_CONTENT="$(cat .github/nav-template.md)"
        NAV_CONTENT="${NAV_CONTENT//$'\n'/\\n}"
        echo "nav=$NAV_CONTENT" >> $GITHUB_OUTPUT

    - name: Inject nav into README files
      run: |
        for file in $(git ls-files '*.md'); do
          if grep -q "<!-- inject-nav -->" "$file"; then
            echo "Injecting nav into $file"
            sed -i "s|<!-- inject-nav -->|${{ steps.nav.outputs.nav }}|g" "$file"
          fi
        done

    - name: Commit changes
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "Auto-injected nav menu"
          git push
        else
          echo "No changes to commit."
        fi

