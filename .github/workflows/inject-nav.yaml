name: Inject Navigation Menu

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  inject:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Navigation Menu
        id: nav
        run: |
          echo "Generating navigation menu..."

          NAV="## ðŸ“˜ Navigation Menu\n"

          # Find every README.md safely (UTF-8 + spaces)
          while IFS= read -r -d '' readme; do

            folder=$(dirname "$readme")

            # Extract title
            if [[ "$folder" == "." ]]; then
              title="Home"
              url="/README.md"
            else
              # Last folder name
              name=$(basename "$folder")
              # Replace hyphens with spaces
              pretty=$(echo "$name" | sed 's/-/ /g')

              # URL encode path using Python
              encoded=$(python3 - <<EOF
import urllib.parse
print(urllib.parse.quote("$folder"))
EOF
)
              url="/$encoded/README.md"
              title="$pretty"
            fi

            NAV+="[$title]($url) â€¢ "

          done < <(find . -type f -name "README.md" -print0)

          NAV+="\n\n---\n<!-- inject-nav -->"

          echo "nav<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$NAV" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Inject Navigation Menu
        run: |
          NAV_CONTENT="${{ steps.nav.outputs.nav }}"

          while IFS= read -r -d '' file; do
            if grep -q "<!-- inject-nav -->" "$file"; then
              echo "Skipping $file (already has nav)"
              continue
            fi

            echo "Injecting nav into $file"
            tmp=$(mktemp)

            echo -e "$NAV_CONTENT" > "$tmp"
            cat "$file" >> "$tmp"

            mv "$tmp" "$file"
          done < <(find . -type f -name "README.md" -print0)

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-injected navigation menu"
